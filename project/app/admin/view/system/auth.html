<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色授权</title>
    <link rel="stylesheet" href="__STATIC__/layuimini/js/lay-module/dtree/dtree.css">
    <link rel="stylesheet" href="__STATIC__/layuimini/js/lay-module/dtree/font/dtreefont.css">
</head>

<body>
    <div class="auth-box">
        <div id="auth-tree" class="dtree" data-id="0"></div>
        <button id="save-auth" class="layui-btn layui-btn-normal">提交修改</button>
    </div>
    <style>
        .auth-box {
            width: 80%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #save-auth {
            margin-top: 40px;
        }
    </style>
    {include file='common/config'/}
    <script>


        function LoadData(row) {

            layui.use(['jquery', 'dtree', 'api'], function () {
                let $ = layui.jquery;
                let dtree = layui.dtree;
                let api = layui.api;
                let authTree = dtree.render({
                    elem: "#auth-tree",
                    checkbar: true,
                    checkbarType: "all",
                    dataStyle: "layuiStyle",  //使用layui风格的数据格式
                    dataFormat: "list",  //配置data的风格为list
                    url: zconfig.createLink("domain.System/getAllMenu"),
                    response: {
                        statusName: "errCode", //返回标识（必填）
                        statusCode: 0,
                        message: "msg", //返回信息（必填）
                        parentId: 'pid',
                    },
                    done: function (res, ul, first) {
                        if (first) {
                            // console.log(authTree);
                            api.request("domain.Role/getAuthByRole", { id: row.id }, (res) => {
                                dtree.chooseDataInit('auth-tree', res.data); // 初始化选
                            })
                        }
                    }

                });


                //按钮点击
                $('#save-auth').click(function (e) {
                    let params = dtree.getCheckbarNodesParam("auth-tree");
                    let keys = [];
                    for (const key in params) {
                        if (Object.hasOwnProperty.call(params, key)) {
                            keys.push(params[key].nodeId);
                        }
                    }
                    api.request("domain.Role/setAuth", { id: row.id, choose: keys }, (res) => {
                        if (res) {
                            var iframeIndex = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(iframeIndex);

                        }

                    })
                });
            })
        }
    </script>
</body>

</html>